<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example: Structuring LLM responses for text analysis • quanteda.llm</title>
<script src="../../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../../deps/search-1.0.0/fuse.min.js"></script><script src="../../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../../pkgdown.js"></script><meta property="og:title" content="Example: Structuring LLM responses for text analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../../index.html">quanteda.llm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-quick-start" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Quick Start</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-quick-start">
<li><a class="dropdown-item" href="../../../articles/getting-started.html">Quick Start Guide</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../../../articles/pkgdown/examples/summarizing.html">Summarizing texts</a></li>
    <li><a class="dropdown-item" href="../../../articles/pkgdown/examples/salience.html">Salience rating of topics</a></li>
    <li><a class="dropdown-item" href="../../../articles/pkgdown/examples/scoring.html">Scaling texts</a></li>
    <li><a class="dropdown-item" href="../../../articles/pkgdown/examples/structuring.html">Structuring LLM responses for text analysis</a></li>
    <li><a class="dropdown-item" href="../../../articles/pkgdown/examples/validating.html">Validating LLM responses</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/quanteda/quanteda.llm"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="structuring_files/kePrint-0.0.1/kePrint.js"></script><link href="structuring_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example: Structuring LLM responses for text analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/quanteda/quanteda.llm/blob/main/vignettes/pkgdown/examples/structuring.Rmd" class="external-link"><code>vignettes/pkgdown/examples/structuring.Rmd</code></a></small>
      <div class="d-none name"><code>structuring.Rmd</code></div>
    </div>

    
    
<p>The package allows you to structure the responses from LLMs in a way
that is compatible with <code>quanteda</code>’s corpus principles and
useful for common text analysis tasks. This means you can easily
integrate LLM-generated data into your text analysis workflows. For
example, you can ask an LLM to summarize all documents in a corpus
(<code><a href="../../../reference/ai_summary.html">ai_summary()</a></code>) and store the summaries as document
variables, or you can classify documents into topics
(<code><a href="../../../reference/ai_salience.html">ai_salience()</a></code>) or scale them based on predefined criteria
(<code>ai_scale()</code>) and store the results as document
variables.</p>
<p>If you need more flexibility in how the LLM generates its output, you
can use the <code><a href="../../../reference/ai_text.html">ai_text()</a></code> function to define custom prompts and
response structures. With <code><a href="../../../reference/ai_text.html">ai_text()</a></code> and the help of the
<code><a href="https://ellmer.tidyverse.org/reference/type_boolean.html" class="external-link">type_object()</a></code> argument from the <code>ellmer</code>
package, you can define how the LLM should format its output, such as
specifying the fields to include in the response or the format of the
response itself. This flexibility enables you to tailor the LLM’s output
to your analysis requirements, making it easier to integrate
LLM-generated data into your text analysis workflows.</p>
<div class="section level3">
<h3 id="loading-packages-and-data">Loading packages and data<a class="anchor" aria-label="anchor" href="#loading-packages-and-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://quanteda.io" class="external-link">quanteda</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Package version: 4.3.1</span></span>
<span><span class="co">## Unicode version: 15.1</span></span>
<span><span class="co">## ICU version: 74.2</span></span></code></pre>
<pre><code><span><span class="co">## Parallel computing: disabled</span></span></code></pre>
<pre><code><span><span class="co">## See https://quanteda.io for tutorials and examples.</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/quanteda/quanteda.llm" class="external-link">quanteda.llm</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: ellmer</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">quanteda.tidy</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'quanteda.tidy'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_corpus_inaugural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-ai_text-for-scoring-documents">Using <code>ai_text()</code> for scoring documents<a class="anchor" aria-label="anchor" href="#using-ai_text-for-scoring-documents"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prompt</span> <span class="op">&lt;-</span> <span class="st">"Score the following document on a scale of how much it aligns</span></span>
<span><span class="st">with the political left. The political left is defined as groups which</span></span>
<span><span class="st">advocate for social equality, government intervention in the economy,</span></span>
<span><span class="st">and progressive policies. Use the following metrics:</span></span>
<span><span class="st">SCORING METRIC:</span></span>
<span><span class="st">3 : extremely left</span></span>
<span><span class="st">2 : very left</span></span>
<span><span class="st">1 : slightly left</span></span>
<span><span class="st">0 : not at all left"</span></span>
<span></span>
<span><span class="co"># define the structure of the response</span></span>
<span><span class="va">policy_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/type_boolean.html" class="external-link">type_object</a></span><span class="op">(</span></span>
<span>  score <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/type_boolean.html" class="external-link">type_integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  evidence <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/type_boolean.html" class="external-link">type_string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_corpus_inaugural</span> <span class="op">&lt;-</span> <span class="va">data_corpus_inaugural</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="../../../reference/ai_text.html">ai_text</a></span><span class="op">(</span><span class="va">text</span>, chat_fn <span class="op">=</span> <span class="va">chat_openai</span>, model <span class="op">=</span> <span class="st">"gpt-4o"</span>, type_object <span class="op">=</span> <span class="va">policy_scores</span>,</span>
<span>                 system_prompt <span class="op">=</span> <span class="va">prompt</span>,</span>
<span>                  api_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temperature <span class="op">=</span> <span class="fl">0</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Using `chat_openai()` with model <span style="color: #0000BB;">"gpt-4o"</span></span></span>
<span><span class="co">## <span style="color: #00BB00;">■■■■■■■■■■■                     </span> 1/3 |  33% | ETA:  9s | <span style="color: #0000BB;">1</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■           </span> 2/3 |  67% | ETA:  5s | <span style="color: #0000BB;">2</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ </span> 3/3 | 100% | ETA:  0s | <span style="color: #0000BB;">3</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Processed <span style="color: #0000BB;">3</span> documents successfully</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># score and evidence are created as new docvars in the corpus</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/" class="external-link">kableExtra</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>docnames <span class="op">=</span> <span class="fu"><a href="https://quanteda.io/reference/docnames.html" class="external-link">docnames</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://quanteda.io/reference/docvars.html" class="external-link">docvars</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span><span class="op">)</span>, <span class="va">score</span>, <span class="va">evidence</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="st">"html"</span>, escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html" class="external-link">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"striped"</span>, <span class="st">"hover"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/column_spec.html" class="external-link">column_spec</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> </span></code></pre></div>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
docnames
</th>
<th style="text-align:left;">
score
</th>
<th style="text-align:left;">
evidence
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
2017-Trump
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
The speech emphasizes nationalism, protectionism, and a focus on
‘America first’ policies, which are not typically aligned with the
political left. It criticizes the political establishment and globalism,
and promotes a vision of national pride and self-reliance. The speech
does not advocate for social equality, government intervention in the
economy, or progressive policies, which are key tenets of the political
left. Instead, it focuses on returning power to the people and
prioritizing American interests, which aligns more with right-wing
populism.
</td>
</tr>
<tr>
<td style="text-align:left;">
2021-Biden
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:left;">
The speech emphasizes themes of unity, democracy, and addressing
systemic issues such as racial justice and climate change, which align
with progressive policies. It also calls for government action to tackle
the pandemic, economic challenges, and social inequalities, reflecting a
left-leaning perspective on government intervention in the economy and
social equality. However, the speech also focuses on unity and
bipartisanship, which slightly moderates its alignment with the
political left.
</td>
</tr>
<tr>
<td style="text-align:left;">
2025-Trump
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
The speech emphasizes nationalism, border security, and a strong
military, which are typically associated with right-wing politics. It
criticizes government intervention in the economy, such as the Green New
Deal and electric vehicle mandates, and promotes energy independence
through drilling, which aligns with conservative economic policies. The
speech also opposes government censorship and promotes a colorblind,
merit-based society, which are not aligned with progressive policies.
Overall, the speech does not advocate for social equality, government
intervention in the economy, or progressive policies, which are key
tenets of the political left.
</td>
</tr>
</tbody>
</table>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Seraphine F. Maerz, Kenneth Benoit.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
